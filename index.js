// Constantes y configuración
const CUSTOMIZER_OPTIONS_RIGHT_SIDE = {
	Hair: {
		paths: [
			"./assets/customize-look-preview-icons-right-side/hair/hair-1.svg",
			"./assets/customize-look-preview-icons-right-side/hair/hair-2.svg",
			"./assets/customize-look-preview-icons-right-side/hair/hair-3.svg",
			"./assets/customize-look-preview-icons-right-side/hair/hair-4.svg",
			"./assets/customize-look-preview-icons-right-side/hair/hair-5.svg",
			"./assets/customize-look-preview-icons-right-side/hair/hair-6.svg",
		],
	},
	Eyes: {
		paths: [
			"./assets/customize-look-preview-icons-right-side/eyes/eyes-1.svg",
			"./assets/customize-look-preview-icons-right-side/eyes/eyes-2.svg",
			"./assets/customize-look-preview-icons-right-side/eyes/eyes-3.svg",
			"./assets/customize-look-preview-icons-right-side/eyes/eyes-4.svg",
			"./assets/customize-look-preview-icons-right-side/eyes/eyes-5.svg",
			"./assets/customize-look-preview-icons-right-side/eyes/eyes-6.svg",
		],
	},
	Mouth: {
		paths: [
			"./assets/customize-look-preview-icons-right-side/mouth/mouth-1.svg",
			"./assets/customize-look-preview-icons-right-side/mouth/mouth-2.svg",
			"./assets/customize-look-preview-icons-right-side/mouth/mouth-3.svg",
			"./assets/customize-look-preview-icons-right-side/mouth/mouth-4.svg",
			"./assets/customize-look-preview-icons-right-side/mouth/mouth-5.svg",
			"./assets/customize-look-preview-icons-right-side/mouth/mouth-6.svg",
		],
	},
	Ears: {
		paths: [
			"./assets/customize-look-preview-icons-right-side/ears/ears-1.svg",
			"./assets/customize-look-preview-icons-right-side/ears/ears-2.svg",
			"./assets/customize-look-preview-icons-right-side/ears/ears-3.svg",
			"./assets/customize-look-preview-icons-right-side/ears/ears-4.svg",
			"./assets/customize-look-preview-icons-right-side/ears/ears-5.svg",
		],
	},
	Accessories: {
		paths: [
			"./assets/customize-look-preview-icons-right-side/accessories/accessory-1.svg",
			"./assets/customize-look-preview-icons-right-side/accessories/accessory-2.svg",
			"./assets/customize-look-preview-icons-right-side/accessories/accessory-3.svg",
			"./assets/customize-look-preview-icons-right-side/accessories/accessory-4.svg",
			"./assets/customize-look-preview-icons-right-side/accessories/accessory-5.svg",
		],
	},
	Nose: {
		paths: [
			"./assets/customize-look-preview-icons-right-side/nose/nose-1.svg",
			"./assets/customize-look-preview-icons-right-side/nose/nose-2.svg",
			"./assets/customize-look-preview-icons-right-side/nose/nose-3.svg",
			"./assets/customize-look-preview-icons-right-side/nose/nose-4.svg",
			"./assets/customize-look-preview-icons-right-side/nose/nose-5.svg",
			"./assets/customize-look-preview-icons-right-side/nose/nose-6.svg",
		],
	},
	Background: {
		colors: [
			"#d3d9de", // Gris
			"#FF5733", // Rojo
			"#33FF57", // Verde
			"#3357FF", // Azul
			"#8E44AD", // Púrpura
			"#E67E22", // Naranja
		],
	},
};

const CUSTOMIZER_OPTIONS_LEFT_SIDE = {
	Hair: {
		paths: [
			"./assets/character-images-left-side/hair/hair-1.png",
			"./assets/character-images-left-side/hair/hair-2.png",
			"./assets/character-images-left-side/hair/hair-3.png",
			"./assets/character-images-left-side/hair/hair-4.png",
			"./assets/character-images-left-side/hair/hair-5.png",
			"./assets/character-images-left-side/hair/hair-6.png",
		],
	},
	Eyes: {
		paths: [
			"./assets/character-images-left-side/eyes/eye-1.png",
			"./assets/character-images-left-side/eyes/eye-2.png",
			"./assets/character-images-left-side/eyes/eye-3.png",
			"./assets/character-images-left-side/eyes/eye-4.png",
			"./assets/character-images-left-side/eyes/eye-5.png",
			"./assets/character-images-left-side/eyes/eye-6.png",
			"./assets/character-images-left-side/eyes/eye-7.png",
		],
	},
	Mouth: {
		paths: [
			"./assets/character-images-left-side/mouth/mouth-1.png",
			"./assets/character-images-left-side/mouth/mouth-2.png",
			"./assets/character-images-left-side/mouth/mouth-3.png",
			"./assets/character-images-left-side/mouth/mouth-4.png",
			"./assets/character-images-left-side/mouth/mouth-5.png",
			"./assets/character-images-left-side/mouth/mouth-6.png",
		],
	},
	Ears: {
		paths: [
			"./assets/character-images-left-side/ears/ear-1.png",
			"./assets/character-images-left-side/ears/ear-2.png",
			"./assets/character-images-left-side/ears/ear-3.png",
			"./assets/character-images-left-side/ears/ear-4.png",
			"./assets/character-images-left-side/ears/ear-5.png",
			"./assets/character-images-left-side/ears/ear-6.png",
		],
	},
	Accessories: {
		paths: [
			"./assets/character-images-left-side/accessories/accessory-1.png",
			"./assets/character-images-left-side/accessories/accessory-2.png",
			"./assets/character-images-left-side/accessories/accessory-3.png",
			"./assets/character-images-left-side/accessories/accessory-4.png",
			"./assets/character-images-left-side/accessories/accessory-5.png",
		],
	},
	Nose: {
		paths: [
			"./assets/character-images-left-side/nose/nose-1.png",
			"./assets/character-images-left-side/nose/nose-2.png",
			"./assets/character-images-left-side/nose/nose-3.png",
			"./assets/character-images-left-side/nose/nose-4.png",
			"./assets/character-images-left-side/nose/nose-5.png",
			"./assets/character-images-left-side/nose/nose-6.png",
		],
	},
	Background: {
		colors: [
			"#d3d9de", // Gris
			"#FF5733", // Rojo
			"#33FF57", // Verde
			"#3357FF", // Azul
			"#8E44AD", // Púrpura
			"#E67E22", // Naranja
		],
	},
};
class Character {
	constructor() {
		this.hair = CUSTOMIZER_OPTIONS_LEFT_SIDE.Hair.paths[0];
		this.eyes = CUSTOMIZER_OPTIONS_LEFT_SIDE.Eyes.paths[0];
		this.mouth = CUSTOMIZER_OPTIONS_LEFT_SIDE.Mouth.paths[0];
		this.ears = null;
		this.accessories = CUSTOMIZER_OPTIONS_LEFT_SIDE.Accessories.paths[1];
		this.nose = CUSTOMIZER_OPTIONS_LEFT_SIDE.Nose.paths[0];
		this.background = CUSTOMIZER_OPTIONS_RIGHT_SIDE.Background.colors[0];
		this.body =
			"./assets/customize-look-preview-icons-right-side/default/body.svg";
	}
	setProperty(property, value) {
		this[property] = value;
	}
	getProperty(property) {
		return this[property];
	}
	getCharacter() {
		return {
			hair: this.hair,
			eyes: this.eyes,
			mouth: this.mouth,
			ears: this.ears,
			accessories: this.accessories,
			nose: this.nose,
			background: this.background,
		};
	}
	setCharacter(character) {
		this.hair = character.hair;
		this.eyes = character.eyes;
		this.mouth = character.mouth;
		this.ears = character.ears;
		this.accessories = character.accessories;
		this.nose = character.nose;
		this.background = character.background;
	}
	clearProperties() {
		this.hair = null;
		this.eyes = null;
		this.mouth = null;
		this.ears = null;
		this.accessories = null;
		this.nose = null;
		this.background = null;
	}
}

const CUSTOMIZER_BUTTONS = [
	"Hair",
	"Eyes",
	"Ears",
	"Nose",
	"Mouth",
	"Background",
	"Accessories",
];

// Funciones utilitarias para carga y descarga
const loadImage = src =>
	new Promise(resolve => {
		const img = new Image();
		img.crossOrigin = "Anonymous";
		img.onload = () => resolve(img);
		img.onerror = () => resolve(null);
		img.src = src;
	});

const loadImages = srcArray =>
	Promise.all(srcArray.map(loadImage));

const downloadBlob = (blob, fileName) => {
	const url = URL.createObjectURL(blob);
	const a = document.createElement("a");
	a.href = url;
	a.download = fileName;
	document.body.appendChild(a);
	a.click();
	document.body.removeChild(a);
	URL.revokeObjectURL(url);
};

// Utilidades
const createElement = (tag, attributes = {}, children = []) => {
	const element = document.createElement(tag);
	for (const [key, value] of Object.entries(attributes)) {
		element[key] = value;
	}
	for (const child of children) {
		element.appendChild(child);
	}
	return element;
};

const handleError = (error, context) => {
	console.error(`Error in ${context}:`, error);
	// Aquí podrías agregar un manejo de errores más sofisticado
};

// Funciones principales
const initializeCharacterTitle = () => {
	try {
		const title = document.getElementById("character-title");
		if (!title) throw new Error("Character title element not found");
		title.textContent = title.textContent.toUpperCase();
	} catch (error) {
		handleError(error, "initializeCharacterTitle");
	}
};
const clearCharacterPreview = (characterContainer) => {
	try {
		if (!characterContainer) throw new Error("Character container not found");
		const images = characterContainer.querySelectorAll(
			".character-preview__image",
		);
		for (const image of images) {
			if (image.id !== "basic-character") {
				characterContainer.removeChild(image);
			}
		}
	} catch (error) {
		handleError(error, "clearCharacterPreview");
	}
};

const initializeCharacterPreview = (characterContainer, character) => {
	try {
		const basicCharacter = createElement("img", {
			src: "./assets/character-images-left-side/default/basic-character.png",
			alt: "basic character",
			className: "character-preview__image",
		});
		for (const [key, value] of Object.entries(character.getCharacter())) {
			if (value && key !== "background") {
				const img = createElement("img", {
					id: `character-preview-image__${key.toLowerCase()}`,
					src: value,
					alt: key,
					className: `character-preview__image ${key.toLowerCase()}`,
				});
				characterContainer.appendChild(img);
			} else if (key === "background") {
				characterContainer.style.backgroundColor = value;
			}
		}
		characterContainer.appendChild(basicCharacter);
	} catch (error) {
		handleError(error, "initializeCharacterPreview");
	}
};

const createCustomizerButton = (name) => {
	return createElement("button", {
		id: name.toLowerCase(),
		textContent: name,
		className: "btn btn__terciary",
		type: "button",
	});
};

const displayCustomizerButtons = container => {
	try {
		container.innerHTML = ""; // limpia antes
		const fragment = document.createDocumentFragment();
		for (const name of CUSTOMIZER_BUTTONS) {
			fragment.appendChild(createCustomizerButton(name));
		};
		container.appendChild(fragment);
	} catch (error) {
		handleError(error, "displayCustomizerButtons");
	}
};

const removeActiveOptionSelected = () => {
	const activeButton = document.querySelector(".btn__terciary-active");
	if (activeButton) {
		activeButton.classList.remove("btn__terciary-active");
	}
};

const createCustomizerImage = (path, name, index) => {
	return createElement("img", {
		src: path,
		id: `${name.toLowerCase()}-option-${index + 1}`,
		alt: `${name.toLowerCase()}-option-${index + 1}`,
		className: "customizer-option-image",
	});
};

const displayCustomizerOptions = (optionName, characterContainer, character) => {
	try {
		const container = document.getElementById("customizer-select");
		removeActiveOptionSelected();
		document.getElementById(optionName.toLowerCase())?.classList.add("btn__terciary-active");

		const fragment = document.createDocumentFragment();
		const option = CUSTOMIZER_OPTIONS_RIGHT_SIDE[optionName];

		if (optionName === "Background") {
			for (const color of option.colors){
				const box = createElement("div", {
					className: "customizer-option-color",
					style: `background-color: ${color};`,
				});
				box.addEventListener("click", () => changeBackgroundColor(color, characterContainer));
				fragment.appendChild(box);
			};
		} else {
			option.paths.forEach((path, idx) => {
				const img = createCustomizerImage(path, optionName, idx);
				img.addEventListener("click", e => {
					e.stopPropagation();
					updateCharacter(character, optionName, idx);
				});
				fragment.appendChild(img);
			});
		}

		container.innerHTML = "";
		container.appendChild(fragment);
	} catch (error) {
		handleError(error, "displayCustomizerOptions");
	}
};
const updateCharacter = (character, property, valueIndex) => {
	const value = CUSTOMIZER_OPTIONS_LEFT_SIDE[property].paths[valueIndex];
	console.log(property, value);
	character.setProperty(property.toLowerCase(), value);
	const characterPreviewImage = document.getElementById(
		`character-preview-image__${property.toLowerCase()}`,
	);
	if (characterPreviewImage) {
		characterPreviewImage.src = value;
	}
	console.log(character.getCharacter());
};

// Gestión de eventos
const setupEventListeners = (
	customizerButtonsContainer,
	characterContainer,
	character,
	randomButton,
	downloadButton,
) => {
	const handleOnClickCustomizerOptions = (event) => {
		const button = event.target.closest("button");
		if (!button) return;
		displayCustomizerOptions(button.textContent, characterContainer, character);
	};
	const handleOnClickRandomizer = () => {
		const randomCharacter = new Character();
		const randomizerOptions = Object.keys(CUSTOMIZER_OPTIONS_LEFT_SIDE);

		for (const option of randomizerOptions) {
			if (option === "Background") {
				const randomIndex = getRandomNumber(
					0,
					CUSTOMIZER_OPTIONS_LEFT_SIDE[option].colors.length - 1,
				);
				randomCharacter.setProperty(
					option.toLowerCase(),
					CUSTOMIZER_OPTIONS_LEFT_SIDE[option].colors[randomIndex],
				);
			} else {
				const randomIndex = getRandomNumber(
					0,
					CUSTOMIZER_OPTIONS_LEFT_SIDE[option].paths.length - 2,
				);
				randomCharacter.setProperty(
					option.toLowerCase(),
					CUSTOMIZER_OPTIONS_LEFT_SIDE[option].paths[randomIndex],
				);
			}
		}
		clearCharacterPreview(characterContainer);
		character.setCharacter(randomCharacter.getCharacter());
		initializeCharacterPreview(characterContainer, character);
	};
	const handleOnClickDownload = async () => {
		const { width, height } = characterContainer.getBoundingClientRect();
		const canvas = document.createElement("canvas");
		const ctx = canvas.getContext("2d");
		const ratio = window.devicePixelRatio || 1;
		canvas.width = width * ratio;
		canvas.height = height * ratio;
		ctx.scale(ratio, ratio);

		// Fondo
		ctx.fillStyle = getComputedStyle(characterContainer).backgroundColor;
		ctx.fillRect(0, 0, width, height);

		// Carga simultánea de imágenes
		const srcs = Array.from(characterContainer.querySelectorAll("img")).map(el => el.src);
		const images = await loadImages(srcs);

		// Dibuja todas
		for (const img of images) {
			if (img) ctx.drawImage(img, 0, 0, width, height);
		};

		// Convertir a Blob y descargar
		canvas.toBlob(blob => {
			if (blob) downloadBlob(blob, "my-custom-character.png");
		}, "image/png");
	};

	customizerButtonsContainer.addEventListener(
		"click",
		handleOnClickCustomizerOptions,
	);
	randomButton.addEventListener("click", handleOnClickRandomizer);
	downloadButton.addEventListener("click", handleOnClickDownload);

	// Retornamos la función de limpieza
	return () => {
		customizerButtonsContainer.removeEventListener(
			"click",
			handleOnClickCustomizerOptions,
		);
		randomButton.removeEventListener("click", handleOnClickRandomizer);
		downloadButton.removeEventListener("click", handleOnClickDownload);
	};
};

// Inicialización
const initializeApp = () => {
	try {
		// 1. Obtener elementos del DOM
		const characterContainer = document.getElementById("character-preview");
		const customizerButtonsContainer =
			document.getElementById("customizer-options");
		const randomizerButton = document.getElementById("random-button");
		const downloadButton = document.getElementById("download-button");
		if (!customizerButtonsContainer) {
			throw new Error("Customizer buttons container not found");
		}
		const character = new Character();

		// 2. Inicializar componentes
		initializeCharacterPreview(characterContainer, character);
		initializeCharacterTitle();
		displayCustomizerButtons(customizerButtonsContainer);
		displayCustomizerOptions("Hair", characterContainer, character);

		// 3. Configurar eventos
		const cleanup = setupEventListeners(
			customizerButtonsContainer,
			characterContainer,
			character,
			randomizerButton,
			downloadButton,
		);

		// 4. Retornar función de limpieza para cuando sea necesario
		return cleanup;
	} catch (error) {
		handleError(error, "initializeApp");
		return () => {}; // Retornar función vacía en caso de error
	}
};

// Iniciar la aplicación cuando el DOM esté listo
let cleanupFunction;
document.addEventListener("DOMContentLoaded", () => {
	cleanupFunction = initializeApp();
});

// Limpiar cuando sea necesario (por ejemplo, en un SPA)
document.addEventListener("beforeunload", () => {
	if (cleanupFunction) {
		cleanupFunction();
	}
});

const changeBackgroundColor = (color, characterContainer) => {
	if (characterContainer) {
		characterContainer.style.backgroundColor = color;
	}
};

const getRandomNumber = (min, max) => {
	return Math.floor(Math.random() * (max - min + 1)) + min;
};
